<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BOXR Parcel Sorter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #0022ee; /* Updated BOXR blue */
      --secondary: #34c759;
      --error: #ff4444;
      --text: #333333;
      --background: #ffffff;
      --card-bg: #f8f9fa;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    [data-theme="dark"] {
      --primary: #3366ff; /* Lighter blue for dark mode */
      --secondary: #34c759;
      --error: #ff6666;
      --text: #ffffff;
      --background: #1a1a1a;
      --card-bg: #2d2d2d;
      --shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background);
      color: var(--text);
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    #logo {
      max-height: 50px;
      width: auto;
    }

    #theme-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text);
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--primary);
    }

    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--text);
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      background: var(--background);
      color: var(--text);
    }

    #message {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      background-color: rgba(0, 0, 0, 0.8);
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    #overlay-content {
      color: #fff;
      font-size: 2rem;
      font-weight: bold;
      padding: 1rem;
      border-radius: 4px;
      text-align: center;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    select, button {
      padding: 8px 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: var(--background);
      color: var(--text);
      cursor: pointer;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      transition: background 0.3s;
    }

    button:hover:not(:disabled) {
      background: #0019b3; /* Darker shade of #0022ee */
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    #scans-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #scans-list li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" src="https://cdn.shopify.com/s/files/1/0596/0197/7522/files/LG_BOXR_RGB.png?v=1742596684" alt="BOXR Logo">
      <button id="theme-toggle">ðŸŒ™</button>
    </header>

    <div class="card" id="app">
      <h1>BOXR Parcel Sorter</h1>
      <p>Current Step: <strong id="current-step">Scan Package</strong></p>
      <input type="text" id="scanner-input" placeholder="Scan here..." autofocus />
      <div id="message"></div>
    </div>

    <div id="overlay">
      <div id="overlay-content"></div>
    </div>

    <audio id="success-sound" src="success.mp3" preload="auto"></audio>
    <audio id="error-sound" src="error.mp3" preload="auto"></audio>

    <div class="card">
      <h2>Bin Management</h2>
      <div class="controls">
        <select id="carrier-select">
          <option value="">Select Carrier</option>
        </select>
        <button id="create-bin-btn" disabled>Create Bin Label</button>
        <select id="label-type-select">
          <option value="barcode">Barcode</option>
          <option value="qr">QR Code</option>
        </select>
      </div>
      <div id="current-bins">Select a carrier to see current bins</div>
    </div>

    <div class="card">
      <h2>Analytics</h2>
      <div class="controls">
        <select id="time-filter">
          <option value="all">All Time</option>
          <option value="24h">Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
        </select>
      </div>
      <div id="analytics-grid">
        <div class="chart-container">
          <canvas id="carrier-chart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="scans-per-hour"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bins-chart"></canvas>
        </div>
      </div>
      <button id="exportBtn">Export CSV</button>
    </div>

    <div class="card">
      <h2>Recent Scans</h2>
      <ul id="scans-list"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, getDoc, doc, query, orderBy, onSnapshot, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQ6tvUMj2UQUQ3OU5cYdcod_ZUySi2D2s",
      authDomain: "boxr-parcel-sorter.firebaseapp.com",
      projectId: "boxr-parcel-sorter",
      storageBucket: "boxr-parcel-sorter.firebasestorage.app",
      messagingSenderId: "615746259085",
      appId: "1:615746259085:web:b6f7cba3edf84901bcfac4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const carriers = [
      { name: "DHL Paket", prefixes: ["8064"], logo: "logos/dhl_paket.png" },
      { name: "DHL NL", prefixes: ["JVGL"], logo: "logos/dhl_nl.png" },
      { name: "Correos Express", prefixes: ["PKANF"], logo: "logos/correos_express.png" },
      { name: "BPOST", prefixes: ["323201"], logo: "logos/bpost.png" },
      { name: "Colis Prive", prefixes: ["Q788", "R153"], logo: "logos/colis_prive.png" },
      { name: "DPD", prefixes: ["0522"], logo: "logos/dpd.png" }
    ];

    let currentStep = "scanPackage";
    let expectedBin = null;

    const scannerInput = document.getElementById("scanner-input");
    const messageDiv = document.getElementById("message");
    const currentStepLabel = document.getElementById("current-step");
    const overlay = document.getElementById("overlay");
    const overlayContent = document.getElementById("overlay-content");
    const successSound = document.getElementById("success-sound");
    const errorSound = document.getElementById("error-sound");
    const carrierSelect = document.getElementById("carrier-select");
    const createBinBtn = document.getElementById("create-bin-btn");
    const currentBinsDiv = document.getElementById("current-bins");
    const labelTypeSelect = document.getElementById("label-type-select");
    const themeToggle = document.getElementById("theme-toggle");
    const logo = document.getElementById("logo");
    const timeFilter = document.getElementById("time-filter");
    const scansList = document.getElementById("scans-list");
    const exportBtn = document.getElementById("exportBtn");

    let overlayHideTimeoutId = null;
    let charts = {};

    // Dark mode toggle
    themeToggle.addEventListener("click", () => {
      document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
      themeToggle.textContent = document.body.dataset.theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
    });

    // Populate carriers
    carriers.forEach((carrier) => {
      const option = document.createElement("option");
      option.value = carrier.name;
      option.textContent = carrier.name;
      carrierSelect.appendChild(option);
    });

    // Event listeners
    scannerInput.addEventListener("change", handleScan);
    overlay.addEventListener("click", hideOverlay);
    carrierSelect.addEventListener("change", () => {
      createBinBtn.disabled = !carrierSelect.value;
      loadCarrierBins(carrierSelect.value);
    });
    createBinBtn.addEventListener("click", createNewBin);
    timeFilter.addEventListener("change", updateAnalytics);
    exportBtn.addEventListener("click", exportCSV);

    function handleScan() {
      const code = scannerInput.value.trim();
      scannerInput.value = "";
      if (!code) return;

      if (currentStep === "scanPackage") {
        handlePackageScan(code);
      } else {
        handleBinScan(code);
      }
    }

    async function handlePackageScan(barcode) {
      const carrier = findCarrierByPrefix(barcode);
      if (!carrier) {
        showMessage("Unknown carrier!", false);
        showOverlay("Unknown carrier!", false);
        return;
      }

      const binCode = await getOpenBinForCarrier(carrier.name);
      if (!binCode) {
        showMessage(`No open bin for ${carrier.name}! Create one.`, false);
        showOverlay(`No open bin for ${carrier.name}!`, false);
        return;
      }

      showMessage(`Package: ${carrier.name}. Scan bin ${binCode}.`, true);
      showOverlay(`Scan bin ${binCode}...`, true);
      expectedBin = binCode;
      currentStep = "scanBin";
      updateStepLabel();

      try {
        await addDoc(collection(db, "scans"), {
          step: "packageScan",
          carrier: carrier.name,
          trackingNumber: barcode,
          bin: binCode,
          timestamp: Date.now()
        });
      } catch (err) {
        console.error("Error saving package scan:", err);
      }
    }

    async function handleBinScan(scannedBin) {
      if (scannedBin === expectedBin) {
        showMessage("Sorting Complete!", true);
        showOverlay("Correct Bin!", true);
        try {
          await addDoc(collection(db, "scans"), {
            step: "binScan",
            bin: scannedBin,
            status: "correct",
            timestamp: Date.now()
          });
        } catch (err) {
          console.error("Error saving bin scan:", err);
        }
      } else {
        showMessage(`Wrong bin! Expected ${expectedBin}.`, false);
        showOverlay(`Wrong bin! Expected ${expectedBin}`, false);
        try {
          await addDoc(collection(db, "scans"), {
            step: "binScan",
            bin: scannedBin,
            status: "incorrect",
            expected: expectedBin,
            timestamp: Date.now()
          });
        } catch (err) {
          console.error("Error saving bin error:", err);
        }
        return;
      }

      currentStep = "scanPackage";
      expectedBin = null;
      updateStepLabel();
    }

    function findCarrierByPrefix(barcode) {
      for (const c of carriers) {
        for (const pfx of c.prefixes) {
          if (barcode.startsWith(pfx)) return c;
        }
      }
      return null;
    }

    function showMessage(msg, isSuccess) {
      messageDiv.textContent = msg;
      messageDiv.style.backgroundColor = isSuccess ? "var(--secondary)" : "var(--error)";
      messageDiv.style.color = "#fff";
      isSuccess ? playSuccessSound() : playErrorSound();
    }

    function showOverlay(msg, isSuccess) {
      if (overlayHideTimeoutId) clearTimeout(overlayHideTimeoutId);
      overlay.style.backgroundColor = isSuccess ? "rgba(52,199,89,0.95)" : "rgba(255,68,68,0.95)";
      overlayContent.textContent = msg;
      overlay.style.display = "flex";
      overlayHideTimeoutId = setTimeout(hideOverlay, 2000);
      isSuccess ? playSuccessSound() : playErrorSound();
    }

    function hideOverlay() {
      overlay.style.display = "none";
    }

    function updateStepLabel() {
      currentStepLabel.textContent = currentStep === "scanPackage" ? "Scan Package" : "Scan Bin";
    }

    function playSuccessSound() {
      if (successSound) {
        successSound.currentTime = 0;
        successSound.play().catch(() => {});
      }
    }

    function playErrorSound() {
      if (errorSound) {
        errorSound.currentTime = 0;
        errorSound.play().catch(() => {});
      }
    }

    async function loadCarrierBins(carrierName) {
      if (!carrierName) {
        currentBinsDiv.innerHTML = "Select a carrier to see current bins";
        return;
      }
      let html = `<strong>${carrierName} Bins:</strong><br>`;
      const binsSnap = await getDocs(collection(db, "bins"));
      let found = false;
      binsSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.carrier === carrierName) {
          found = true;
          html += `${data.binCode} (${data.isFull ? 'Full' : 'Open'})<br>`;
        }
      });
      currentBinsDiv.innerHTML = found ? html : `${html}<em>No bins yet</em>`;
    }

    async function createNewBin() {
      const carrierName = carrierSelect.value;
      if (!carrierName) return;

      try {
        const carrierDocRef = doc(db, "carriers", carrierName);
        const binCode = await runTransaction(db, async (transaction) => {
          const carrierDocSnap = await transaction.get(carrierDocRef);
          let binCounter = 1;
          if (!carrierDocSnap.exists()) {
            transaction.set(carrierDocRef, { binCounter: 1 });
          } else {
            binCounter = carrierDocSnap.data().binCounter || 1;
          }

          const binNumberStr = String(binCounter).padStart(4, "0");
          const newBinCode = `${carrierName}-BIN-${binNumberStr}`;

          transaction.set(carrierDocRef, { binCounter: binCounter + 1 }, { merge: true });
          const newBinDocRef = doc(collection(db, "bins"));
          transaction.set(newBinDocRef, {
            carrier: carrierName,
            binCode: newBinCode,
            isFull: false,
            createdAt: Date.now()
          });

          return newBinCode;
        });

        generateBinLabel(carrierName, binCode);
        loadCarrierBins(carrierName);
      } catch (err) {
        console.error("Error creating new bin:", err);
      }
    }

    function generateBinLabel(carrierName, binCode) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [100, 150]
      });

      doc.setLineWidth(0.5);
      doc.rect(5, 5, 90, 140);
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text(carrierName, (100 - doc.getTextWidth(carrierName)) / 2, 20);
      doc.setFontSize(14);
      doc.setFont("helvetica", "normal");
      doc.text(binCode, (100 - doc.getTextWidth(binCode)) / 2, 30);

      const labelType = labelTypeSelect.value;
      if (labelType === "barcode") {
        const barcodeCanvas = document.createElement("canvas");
        JsBarcode(barcodeCanvas, binCode, { format: "CODE128", displayValue: true, fontSize: 14, width: 2, height: 60 });
        doc.addImage(barcodeCanvas.toDataURL("image/png"), 'PNG', 10, 40, 80, 40);
      } else {
        const qrCanvas = document.createElement("canvas");
        new QRious({ element: qrCanvas, value: binCode, size: 100 });
        doc.addImage(qrCanvas.toDataURL("image/png"), 'PNG', 25, 40, 50, 50);
      }

      doc.save(`${binCode}.pdf`);
    }

    async function getOpenBinForCarrier(carrierName) {
      const binsSnap = await getDocs(collection(db, "bins"));
      let chosenBin = null;
      let latestCreated = -1;
      binsSnap.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.carrier === carrierName && !data.isFull && data.createdAt > latestCreated) {
          latestCreated = data.createdAt;
          chosenBin = data.binCode;
        }
      });
      return chosenBin;
    }

    const scansQuery = query(collection(db, "scans"), orderBy("timestamp", "desc"));
    const binsQuery = query(collection(db, "bins"), orderBy("createdAt", "desc"));

    function filterDataByTime(data, filter) {
      const now = Date.now();
      const timeFilters = {
        "24h": 24 * 60 * 60 * 1000,
        "7d": 7 * 24 * 60 * 60 * 1000,
        "30d": 30 * 24 * 60 * 60 * 1000
      };
      return filter === "all" ? data : data.filter(d => now - d.timestamp <= timeFilters[filter]);
    }

    async function updateAnalytics() {
      const scansSnap = await getDocs(scansQuery);
      const binsSnap = await getDocs(binsQuery);
      const allScans = scansSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const allBins = binsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const filteredScans = filterDataByTime(allScans, timeFilter.value);
      const filteredBins = filterDataByTime(allBins, timeFilter.value);

      renderCarrierChart(filteredScans);
      renderScansPerHourChart(filteredScans);
      renderBinsChart(filteredBins);
      renderScansList(filteredScans);
    }

    function renderCarrierChart(scans) {
      const packageScans = scans.filter(s => s.step === "packageScan");
      const carrierCount = packageScans.reduce((acc, s) => {
        acc[s.carrier] = (acc[s.carrier] || 0) + 1;
        return acc;
      }, {});

      if (charts.carrier) charts.carrier.destroy();
      charts.carrier = new Chart(document.getElementById("carrier-chart"), {
        type: "bar",
        data: {
          labels: Object.keys(carrierCount),
          datasets: [{
            label: "Parcels by Carrier",
            data: Object.values(carrierCount),
            backgroundColor: "var(--primary)"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }

    function renderScansPerHourChart(scans) {
      const packageScans = scans.filter(s => s.step === "packageScan");
      const hourlyData = packageScans.reduce((acc, s) => {
        const hour = new Date(s.timestamp).getHours();
        acc[hour] = (acc[hour] || 0) + 1;
        return acc;
      }, Array(24).fill(0));

      if (charts.scansPerHour) charts.scansPerHour.destroy();
      charts.scansPerHour = new Chart(document.getElementById("scans-per-hour"), {
        type: "line",
        data: {
          labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
          datasets: [{
            label: "Scans per Hour",
            data: hourlyData,
            borderColor: "var(--primary)",
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }

    function renderBinsChart(bins) {
      const carrierCount = bins.reduce((acc, b) => {
        acc[b.carrier] = (acc[b.carrier] || 0) + 1;
        return acc;
      }, {});

      if (charts.bins) charts.bins.destroy();
      charts.bins = new Chart(document.getElementById("bins-chart"), {
        type: "pie",
        data: {
          labels: Object.keys(carrierCount),
          datasets: [{
            label: "Bins by Carrier",
            data: Object.values(carrierCount),
            backgroundColor: ["#0022ee", "#34c759", "#ff4444", "#ffa500", "#9370db", "#00ced1"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function renderScansList(scans) {
      scansList.innerHTML = "";
      scans.forEach(s => {
        const li = document.createElement("li");
        const timeStr = new Date(s.timestamp).toLocaleString();
        li.textContent = s.step === "packageScan" 
          ? `[${timeStr}] PACKAGE - ${s.carrier}, #${s.trackingNumber}, Bin: ${s.bin}`
          : `[${timeStr}] BIN - ${s.bin}, ${s.status}`;
        scansList.appendChild(li);
      });
    }

    async function exportCSV() {
      const snap = await getDocs(scansQuery);
      let csv = "step,carrier,trackingNumber,bin,status,timestamp\n";
      snap.forEach(doc => {
        const d = doc.data();
        csv += [d.step || "", d.carrier || "", d.trackingNumber || "", d.bin || "", d.status || "", d.timestamp || ""].join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "scans.csv";
      a.click();
      document.body.removeChild(a);
    }

    // Initial setup
    updateAnalytics();
    onSnapshot(scansQuery, updateAnalytics);
    onSnapshot(binsQuery, updateAnalytics);
  </script>
</body>
</html>
